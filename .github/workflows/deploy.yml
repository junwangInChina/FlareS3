name: Deploy

on:
  workflow_dispatch:

jobs:
  deploy:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
    concurrency:
      group: deploy-production
      cancel-in-progress: false
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            worker/package-lock.json
            frontend/package-lock.json

      - name: Validate deploy configuration
        run: |
          if [ -z "${CLOUDFLARE_API_TOKEN}" ]; then
            echo "Missing required GitHub secret: CLOUDFLARE_API_TOKEN"
            exit 1
          fi
          if [ -z "${CLOUDFLARE_ACCOUNT_ID}" ]; then
            echo "Missing required GitHub secret: CLOUDFLARE_ACCOUNT_ID"
            exit 1
          fi

      - name: Install worker dependencies
        working-directory: "worker"
        run: npm ci

      - name: Ensure D1 database exists (flares3-db) & generate Wrangler CI config
        working-directory: "worker"
        run: |
          set -euo pipefail
          if ! command -v jq >/dev/null 2>&1; then
            echo "jq is required but not installed"
            exit 1
          fi

          DB_NAME="flares3-db"

          D1_ID="$(npx wrangler d1 list --json | jq -r --arg name "${DB_NAME}" '.[] | select(.name==$name) | (.uuid // .database_id // .id)' | head -n 1)"
          if [ -z "${D1_ID}" ] || [ "${D1_ID}" = "null" ]; then
            echo "D1 database not found, creating: ${DB_NAME}"
            if ! npx wrangler d1 create "${DB_NAME}"; then
              echo "wrangler d1 create failed (it may already exist); continuing to resolve id via list"
            fi

            # `wrangler d1 create` does not support --json, so resolve id via list (with retry)
            for i in 1 2 3 4 5; do
              D1_ID="$(npx wrangler d1 list --json | jq -r --arg name "${DB_NAME}" '.[] | select(.name==$name) | (.uuid // .database_id // .id)' | head -n 1)"
              if [ -n "${D1_ID}" ] && [ "${D1_ID}" != "null" ]; then
                break
              fi
              sleep 2
            done
          fi

          if [ -z "${D1_ID}" ] || [ "${D1_ID}" = "null" ]; then
            echo "Failed to resolve D1 database id for ${DB_NAME}"
            exit 1
          fi

          echo "Resolved D1 database id: ${D1_ID}"

          # Generate CI config with concrete database_id (avoid committing id to repo)
          sed -E "s/^database_id[[:space:]]*=[[:space:]]*\".*\"/database_id = \"${D1_ID}\"/" wrangler.toml > wrangler.ci.toml

          echo "WRANGLER_CI_CONFIG=wrangler.ci.toml" >> "${GITHUB_ENV}"

      - name: Ensure R2_MASTER_KEY secret exists
        working-directory: "worker"
        run: |
          set -euo pipefail
          if ! command -v jq >/dev/null 2>&1; then
            echo "jq is required but not installed"
            exit 1
          fi

          KEY_NAME="R2_MASTER_KEY"

          # `wrangler secret list` will fail if the Worker doesn't exist yet.
          # In that case we treat it as empty and create the secret.
          SECRETS_JSON="$(npx wrangler --config "${WRANGLER_CI_CONFIG}" secret list --format json 2>/dev/null || echo '[]')"
          HAS_KEY="$(echo "${SECRETS_JSON}" | jq -r --arg k "${KEY_NAME}" '[.[] | select(.name==$k)] | length')"

          if [ "${HAS_KEY}" != "0" ]; then
            echo "${KEY_NAME} already exists, skipping"
            exit 0
          fi

          echo "${KEY_NAME} not found, generating & uploading (value will NOT be printed)..."
          GENERATED="$(node -e "process.stdout.write(require('crypto').randomBytes(32).toString('base64'))")"
          echo "${GENERATED}" | npx wrangler --config "${WRANGLER_CI_CONFIG}" secret put "${KEY_NAME}"
          echo "${KEY_NAME} uploaded"

      - name: Ensure Pages project exists (flares3-pages)
        working-directory: "worker"
        run: |
          set -euo pipefail

          PROJECT_NAME="flares3-pages"
          PRODUCTION_BRANCH="main"

          echo "Ensuring Pages project exists: ${PROJECT_NAME}"
          if npx wrangler pages project list | grep -Fq "${PROJECT_NAME}"; then
            echo "Pages project exists: ${PROJECT_NAME}"
          else
            echo "Pages project not found, creating: ${PROJECT_NAME}"
            npx wrangler pages project create "${PROJECT_NAME}" --production-branch "${PRODUCTION_BRANCH}"
          fi

      - name: Install frontend dependencies
        working-directory: "frontend"
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Typecheck
        run: npm run typecheck

      - name: Build frontend
        run: npm run build

      - name: Apply D1 schema (idempotent)
        working-directory: "worker"
        run: npx wrangler --config "${WRANGLER_CI_CONFIG}" d1 execute "DB" --remote --file="src/db/schema.sql" --yes

      - name: Deploy Worker
        working-directory: "worker"
        run: npx wrangler --config "${WRANGLER_CI_CONFIG}" deploy

      - name: Deploy Pages
        working-directory: "worker"
        run: npx wrangler pages deploy "../frontend/dist" --project-name="flares3-pages" --branch="${GITHUB_REF_NAME}"
