name: Deploy Worker Only

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
    concurrency:
      group: deploy-worker-only-production
      cancel-in-progress: false
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            worker/package-lock.json
            frontend/package-lock.json

      - name: Validate deploy configuration
        run: |
          if [ -z "${CLOUDFLARE_API_TOKEN}" ]; then
            echo "Missing required GitHub secret: CLOUDFLARE_API_TOKEN"
            exit 1
          fi
          if [ -z "${CLOUDFLARE_ACCOUNT_ID}" ]; then
            echo "Missing required GitHub secret: CLOUDFLARE_ACCOUNT_ID"
            exit 1
          fi

      - name: Install worker dependencies
        working-directory: "worker"
        run: npm ci

      - name: Ensure D1 database exists (flares3-db) & generate Wrangler CI config
        working-directory: "worker"
        run: |
          set -euo pipefail
          if ! command -v jq >/dev/null 2>&1; then
            echo "jq is required but not installed"
            exit 1
          fi

          DB_NAME="flares3-db"

          D1_ID="$(npx wrangler d1 list --json | jq -r --arg name "${DB_NAME}" '.[] | select(.name==$name) | (.uuid // .database_id // .id)' | head -n 1)"
          if [ -z "${D1_ID}" ] || [ "${D1_ID}" = "null" ]; then
            echo "D1 database not found, creating: ${DB_NAME}"
            CREATE_JSON="$(npx wrangler d1 create "${DB_NAME}" --json)"
            D1_ID="$(echo "${CREATE_JSON}" | jq -r '(.uuid // .database_id // .id)')"
          fi

          if [ -z "${D1_ID}" ] || [ "${D1_ID}" = "null" ]; then
            echo "Failed to resolve D1 database id for ${DB_NAME}"
            exit 1
          fi

          echo "Resolved D1 database id: ${D1_ID}"

          # Generate CI config with concrete database_id (avoid committing id to repo)
          sed -E "s/^database_id[[:space:]]*=[[:space:]]*\".*\"/database_id = \"${D1_ID}\"/" wrangler.full.toml > wrangler.full.ci.toml

          echo "WRANGLER_CI_CONFIG=wrangler.full.ci.toml" >> "${GITHUB_ENV}"

      - name: Install frontend dependencies
        working-directory: "frontend"
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Typecheck
        run: npm run typecheck

      - name: Build frontend
        run: npm run build

      - name: Apply D1 schema (idempotent)
        working-directory: "worker"
        run: npx wrangler --config "${WRANGLER_CI_CONFIG}" d1 execute "DB" --remote --file="src/db/schema.sql" --yes

      - name: Deploy Worker (full-stack)
        working-directory: "worker"
        run: npx wrangler --config "${WRANGLER_CI_CONFIG}" deploy
